<!DOCTYPE html>
<html>
<head>
    <title>Sector Alarm Bridge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-temp { border-left: 5px solid #ffc107; }
        .card-alarm { border-left: 5px solid #dc3545; }
        .card-ok { border-left: 5px solid #198754; }
    </style>
</head>
<body class="bg-light container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üõ°Ô∏è Sector Alarm MQTT Bridge</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#configModal">‚öôÔ∏è Settings</button>
    </div>

    <div class="card mb-4 shadow-sm {{ 'card-alarm' if data.status == 'armed' else 'card-ok' }}">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title">System Status</h5>
                <h2 class="mb-0 text-capitalize">{{ data.status }}</h2>
                <small class="text-muted">Last Update: {{ data.last_update }}</small>
            </div>
            <div>
                <span class="badge bg-secondary">{{ config.panel_id }}</span>
            </div>
        </div>
    </div>

    <h5 class="mb-3">Climate Sensors</h5>
    <div class="row g-4">
        {% for sensor in data.sensors %}
        <div class="col-md-4">
            <div class="card h-100 shadow-sm card-temp">
                <div class="card-header bg-white fw-bold">{{ sensor.name }}</div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col">
                            <h3>{{ sensor.temperature }}¬∞C</h3>
                            <small class="text-muted">Temperature</small>
                        </div>
                        {% if sensor.humidity %}
                        <div class="col border-start">
                            <h3>{{ sensor.humidity }}%</h3>
                            <small class="text-muted">Humidity</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Serial: {{ sensor.serial }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/save_config" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Settings</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">MQTT Configuration</h6>
                                <div class="mb-2"><label>Broker IP</label><input type="text" name="mqtt_broker" class="form-control" value="{{ config.mqtt_broker }}" required></div>
                                <div class="mb-2"><label>Port</label><input type="number" name="mqtt_port" class="form-control" value="{{ config.mqtt_port }}" required></div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Sector Alarm Credentials</h6>
                                <div class="mb-2"><label>Email</label><input type="text" name="email" class="form-control" value="{{ config.email }}"></div>
                                <div class="mb-2"><label>Password</label><input type="password" name="password" class="form-control" value="{{ config.password }}"></div>
                                <div class="mb-2"><label>Panel ID</label><input type="text" name="panel_id" class="form-control" value="{{ config.panel_id }}" required></div>
                                <div class="mb-2"><label>Panel Code (for Arming)</label><input type="password" name="panel_code" class="form-control" value="{{ config.panel_code }}"></div>
                            </div>
                        </div>
                        <hr>
                        <h6 class="text-danger">Two-Factor Authentication (2FA) Handling</h6>
                        <p class="small text-muted">If login fails due to 2FA, log in to <code>mypages.sectoralarm.net</code> in your browser, open Developer Tools (F12) -> Application -> Local Storage (or Network tab), find the <code>AuthorizationToken</code> and paste it here.</p>
                        <div class="mb-2">
                            <label>Manual Authorization Token</label>
                            <textarea name="token" class="form-control" rows="3">{{ config.token }}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary">Save & Restart</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>