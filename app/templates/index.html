<!DOCTYPE html>
<html>
<head>
    <title>Sector Alarm Bridge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-temp { border-left: 5px solid #ffc107; }
        .card-ok { border-left: 5px solid #198754; }
        .card-err { border-left: 5px solid #dc3545; }
    </style>
</head>
<body class="bg-light container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üõ°Ô∏è Sector Alarm Bridge</h3>
        <div>
            <span id="state-badge" class="badge bg-{{ 'success' if state == 'CONNECTED' else 'warning' if state == 'WAITING_2FA' else 'danger' }} p-2">
                {{ state }}
            </span>
            <button class="btn btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#configModal">‚öôÔ∏è Settings</button>
        </div>
    </div>

    {% if state == 'WAITING_2FA' %}
    <div class="alert alert-warning shadow-sm border-warning">
        <h4 class="alert-heading">‚ö†Ô∏è Two-Factor Authentication Required</h4>
        <p>The system needs you to verify your identity. Check your phone/email for a code.</p>
        <form action="/submit_2fa" method="post" class="d-flex gap-2">
            <input type="text" name="code" class="form-control" placeholder="Enter 6-digit code" style="max-width: 200px;" required autofocus>
            <button type="submit" class="btn btn-warning fw-bold">Verify Code</button>
        </form>
    </div>
    {% endif %}

    {% if state == 'ERROR' or state == 'STARTING' %}
    <div class="alert alert-secondary">
        <div class="d-flex align-items-center justify-content-between">
            <span>Login failed or not started. You can try triggering 2FA manually.</span>
            <form action="/trigger_2fa" method="post">
                <button class="btn btn-primary btn-sm">Trigger 2FA SMS</button>
            </form>
        </div>
    </div>
    {% endif %}

    {% if state == 'CONNECTED' or data.status != 'Unknown' %}
    <div class="row g-4 mt-2">
        <div class="col-md-12">
            <div class="card shadow-sm {{ 'card-err' if data.status == 'armed' else 'card-ok' }}">
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <h5 class="text-muted">Alarm State</h5>
                        <h2 class="text-capitalize mb-0">{{ data.status }}</h2>
                    </div>
                    <div class="text-end">
                        <small>Last Update: {{ data.last_update }}</small>
                    </div>
                </div>
            </div>
        </div>

        {% for sensor in data.sensors %}
        <div class="col-md-4">
            <div class="card h-100 shadow-sm card-temp">
                <div class="card-body text-center">
                    <h5 class="card-title text-truncate">{{ sensor.name }}</h5>
                    <div class="row mt-3">
                        <div class="col">
                            <h3 class="text-primary">{{ sensor.temperature }}¬∞C</h3>
                            <small class="text-muted">Temp</small>
                        </div>
                        {% if sensor.humidity %}
                        <div class="col border-start">
                            <h3 class="text-info">{{ sensor.humidity }}%</h3>
                            <small class="text-muted">Hum</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/save_config" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Settings</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">MQTT Configuration</h6>
                                <div class="mb-2"><label>Broker IP</label><input type="text" name="mqtt_broker" class="form-control" value="{{ config.mqtt_broker }}" required></div>
                                <div class="mb-2"><label>Port</label><input type="number" name="mqtt_port" class="form-control" value="{{ config.mqtt_port }}" required></div>
                                <div class="mb-2"><label>Username</label><input type="text" name="mqtt_username" class="form-control" value="{{ config.mqtt_username }}"></div>
                                <div class="mb-2"><label>Password</label><input type="password" name="mqtt_password" class="form-control" value="{{ config.mqtt_password }}"></div>
                                <div class="mb-2"><label>Auto-Discovery Prefix</label><input type="text" name="discovery_prefix" class="form-control" value="{{ config.discovery_prefix }}" required></div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Sector Alarm</h6>
                                <div class="mb-2"><label>Email</label><input type="text" name="email" class="form-control" value="{{ config.email }}" required></div>
                                <div class="mb-2"><label>Password</label><input type="password" name="password" class="form-control" value="{{ config.password }}"></div>
                                <div class="mb-2"><label>Panel ID</label><input type="text" name="panel_id" class="form-control" value="{{ config.panel_id }}" required></div>
                                <div class="mb-2"><label>Panel Code (Optional)</label><input type="password" name="panel_code" class="form-control" value="{{ config.panel_code }}"></div>
                            </div>
                        </div>
                        <hr>
                        <div class="mb-2">
                            <label>Polling Interval (Seconds)</label>
                            <input type="number" name="poll_interval" class="form-control" value="{{ config.poll_interval }}" min="10" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary">Save & Restart</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-Refresh Logic
        let currentState = "{{ state }}";
        
        setInterval(async () => {
            try {
                // Add timestamp t=... to prevent browser caching
                const res = await fetch('/api/status?t=' + new Date().getTime());
                if (!res.ok) return;
                
                const data = await res.json();
                
                // Safety check: ignore undefined responses
                if (!data || !data.state) return;

                // Reload if state changes to meaningful values
                if (currentState !== 'CONNECTED' && data.state === 'CONNECTED') {
                    window.location.reload();
                }
                if (currentState !== 'WAITING_2FA' && data.state === 'WAITING_2FA') {
                    window.location.reload();
                }

                currentState = data.state;
                
                // Update badge text
                const badge = document.getElementById('state-badge');
                if(badge) {
                    badge.innerText = currentState;
                }
                
            } catch (e) { console.error("Poll error:", e); }
        }, 2000);
    </script>
</body>
</html>