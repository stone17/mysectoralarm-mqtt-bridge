<!DOCTYPE html>
<html>
<head>
    <title>Sector Alarm Bridge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta http-equiv="refresh" content="10"> </head>
<body class="bg-light container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üõ°Ô∏è Sector Alarm Bridge</h3>
        <div>
            <span class="badge bg-{{ 'success' if state == 'CONNECTED' else 'warning' if state == 'WAITING_2FA' else 'danger' }} p-2">
                {{ state }}
            </span>
            <button class="btn btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#configModal">‚öôÔ∏è Settings</button>
        </div>
    </div>

    {% if state == 'WAITING_2FA' %}
    <div class="alert alert-warning shadow-sm border-warning">
        <h4 class="alert-heading">‚ö†Ô∏è Two-Factor Authentication Required</h4>
        <p>The system needs you to verify your identity. Check your phone/email for a code.</p>
        <form action="/submit_2fa" method="post" class="d-flex gap-2">
            <input type="text" name="code" class="form-control" placeholder="Enter 6-digit code" style="max-width: 200px;" required autofocus>
            <button type="submit" class="btn btn-warning fw-bold">Verify Code</button>
        </form>
    </div>
    {% endif %}

    {% if state == 'ERROR' or state == 'STARTING' %}
    <div class="alert alert-secondary">
        <div class="d-flex align-items-center justify-content-between">
            <span>Login failed or not started. You can try triggering 2FA manually.</span>
            <form action="/trigger_2fa" method="post">
                <button class="btn btn-primary btn-sm">Trigger 2FA SMS</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="row g-4 mt-2">
        <div class="col-md-12">
            <div class="card shadow-sm border-start border-5 border-{{ 'danger' if data.status == 'armed' else 'success' }}">
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <h5 class="text-muted">Alarm State</h5>
                        <h2 class="text-capitalize mb-0">{{ data.status }}</h2>
                    </div>
                    <div class="text-end">
                        <small>Last Update: {{ data.last_update }}</small>
                    </div>
                </div>
            </div>
        </div>

        {% for sensor in data.sensors %}
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-truncate">{{ sensor.name }}</h5>
                    <div class="row mt-3">
                        <div class="col">
                            <h3 class="text-primary">{{ sensor.temperature }}¬∞C</h3>
                        </div>
                        {% if sensor.humidity %}
                        <div class="col border-start">
                            <h3 class="text-info">{{ sensor.humidity }}%</h3>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/save_config" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Configuration</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>MQTT</h6>
                        <input type="text" name="mqtt_broker" class="form-control mb-2" value="{{ config.mqtt_broker }}" placeholder="Broker IP" required>
                        <input type="number" name="mqtt_port" class="form-control mb-2" value="{{ config.mqtt_port }}" placeholder="Port" required>
                        <hr>
                        <h6>Sector Alarm</h6>
                        <input type="text" name="email" class="form-control mb-2" value="{{ config.email }}" placeholder="Email" required>
                        <input type="password" name="password" class="form-control mb-2" value="{{ config.password }}" placeholder="Password" required>
                        <input type="text" name="panel_id" class="form-control mb-2" value="{{ config.panel_id }}" placeholder="Panel ID" required>
                        <input type="password" name="panel_code" class="form-control mb-2" value="{{ config.panel_code }}" placeholder="Panel Code (Optional)">
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary">Save & Restart</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>